<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½èƒ½æºæ¶ˆè€—åˆ†æå™¨ | ä¼˜åŒ–ç¨³å®šç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        /* ===================== ä¿®å¤è“å±é—®é¢˜çš„æ ¸å¿ƒæ ·å¼ ===================== */
        :root {
            --primary-color: #667eea;
            --fallback-bg: #f0f4ff;
            /* æ–°å¢å¤‡ç”¨èƒŒæ™¯è‰² */
        }

        body {
            background: var(--fallback-bg);
            /* é¦–è¦ä¿®å¤ï¼šè®¾ç½®å®‰å…¨èƒŒæ™¯ */
            min-height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #333;
            transition: background 0.5s;
        }

        /* åªæœ‰å½“JSæˆåŠŸåŠ è½½æ—¶æ‰æ˜¾ç¤ºæ¸å˜èƒŒæ™¯ */
        body.loaded {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            opacity: 0;
            /* åˆå§‹éšè— */
            transition: opacity 0.8s ease;
        }

        /* ===================== å“åº”å¼å¸ƒå±€ä¼˜åŒ– ===================== */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        /* ===================== è¾“å…¥éªŒè¯æ ·å¼ ===================== */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group.invalid input {
            border-color: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
        }

        .error-msg {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        /* ===================== è®¾å¤‡åˆ—è¡¨æ ·å¼ ===================== */
        #appliance-list {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            margin-top: 20px;
        }

        .appliance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }

        .appliance-item:hover {
            transform: translateY(-3px);
            background: #f1f5f9;
        }

        /* ===================== ç§»åŠ¨ç«¯ä¼˜åŒ– ===================== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .chart-container {
                overflow-x: auto;
                padding-bottom: 15px;
            }
        }

        /* ===================== åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ ===================== */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===================== JavaScriptç¦ç”¨æç¤º ===================== */
        .js-warning {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>

<body>
    <!-- JavaScriptç¦ç”¨æç¤º -->
    <noscript>
        <style>
            .js-warning {
                display: block !important;
            }

            #loader {
                display: none !important;
            }
        </style>
    </noscript>

    <div class="js-warning">
        âš ï¸ è¯·å¯ç”¨JavaScriptä»¥æ­£å¸¸ä½¿ç”¨æœ¬åº”ç”¨
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="color:white; margin-top:20px;">åŠ è½½ä¸­...</p>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <header>
            <h1 style="text-align:center; margin-bottom:30px;">æ™ºèƒ½èƒ½æºæ¶ˆè€—åˆ†æå™¨</h1>
        </header>

        <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ -->
        <div class="dashboard">
            <div class="stat-card">
                <h3>æ¯æ—¥è€—ç”µé‡</h3>
                <div id="daily-consumption" class="stat-value">0.0 kWh</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width:0%"></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>é¢„ä¼°æœˆç”µè´¹</h3>
                <div id="monthly-cost" class="stat-value">Â¥ 0</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width:0%"></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>ç¢³è¶³è¿¹</h3>
                <div id="carbon-footprint" class="stat-value">0.0 kg</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width:0%"></div>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡è¾“å…¥è¡¨å• -->
        <div class="input-section">
            <h2>æ·»åŠ è®¾å¤‡</h2>
            <div class="input-group">
                <label for="appliance-name">è®¾å¤‡åç§°</label>
                <input type="text" id="appliance-name" placeholder="ä¾‹å¦‚ï¼šç©ºè°ƒ">
            </div>

            <div class="input-group">
                <label for="appliance-power">åŠŸç‡ (W)</label>
                <input type="number" id="appliance-power" min="10" value="100">
                <div class="error-msg">åŠŸç‡éœ€â‰¥10W</div>
            </div>

            <div class="input-group">
                <label for="appliance-hours">æ¯æ—¥ä½¿ç”¨æ—¶é•¿ (å°æ—¶)</label>
                <input type="number" id="appliance-hours" min="0.1" step="0.1" value="4">
            </div>

            <div class="input-group">
                <label for="appliance-category">è®¾å¤‡ç±»åˆ«</label>
                <select id="appliance-category">
                    <option value="å†·æš–ç©ºèª¿" data-icon="â„ï¸">å†·æš–ç©ºèª¿</option>
                    <option value="ç…§æ˜è¨­å‚™" data-icon="ğŸ’¡">ç…§æ˜è¨­å‚™</option>
                    <option value="å®¶åº­å¨›æ¨‚" data-icon="ğŸ“º">å®¶åº­å¨›æ¨‚</option>
                    <option value="å»šæˆ¿é›»å™¨" data-icon="ğŸ³">å»šæˆ¿é›»å™¨</option>
                    <option value="æ´—è¡£æ¸…æ½”" data-icon="ğŸ§º">æ´—è¡£æ¸…æ½”</option>
                    <option value="è¾¦å…¬è¨­å‚™" data-icon="ğŸ’»">è¾¦å…¬è¨­å‚™</option>
                    <option value="å…¶ä»–" data-icon="ğŸ”Œ">å…¶ä»–</option>
                </select>
            </div>

            <button id="add-appliance-btn" class="btn">æ·»åŠ è®¾å¤‡</button>
        </div>

        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div class="device-list">
            <h2>è®¾å¤‡æ¸…å•</h2>
            <div id="appliance-list"></div>
        </div>

        <!-- å›¾è¡¨å®¹å™¨ -->
        <div class="chart-container">
            <canvas id="energy-chart" height="300"></canvas>
        </div>
    </div>

    <script>
        // ======================= æ ¸å¿ƒåº”ç”¨æ¨¡å— =======================
        const EnergyAnalyzer = (() => {
            // çŠ¶æ€ç®¡ç†ä¸­å¿ƒ
            const state = {
                appliances: [],
                settings: {
                    electricityRate: 3.5,
                    carbonFactor: 0.54,
                    peakHoursMultiplier: 1.3
                },
                chart: null,
                domRefs: {}
            };

            // ================= åˆå§‹åŒ–å‡½æ•° =================
            const init = () => {
                initDOMReferences();
                bindEvents();
                loadFromStorage();
                updateUI();
                markAsLoaded(); // å…³é”®ä¿®å¤ï¼šæ ‡è®°åŠ è½½å®Œæˆ
            };

            // ================= DOMå¼•ç”¨åˆå§‹åŒ– =================
            const initDOMReferences = () => {
                state.domRefs = {
                    applianceName: document.getElementById('appliance-name'),
                    appliancePower: document.getElementById('appliance-power'),
                    applianceHours: document.getElementById('appliance-hours'),
                    applianceCategory: document.getElementById('appliance-category'),
                    applianceList: document.getElementById('appliance-list'),
                    addApplianceBtn: document.getElementById('add-appliance-btn'),
                    dailyConsumption: document.getElementById('daily-consumption'),
                    monthlyCost: document.getElementById('monthly-cost'),
                    carbonFootprint: document.getElementById('carbon-footprint')
                };
            };

            // ================= äº‹ä»¶ç»‘å®š =================
            const bindEvents = () => {
                state.domRefs.addApplianceBtn.addEventListener('click', addAppliance);

                state.domRefs.appliancePower.addEventListener('input', () => {
                    validatePowerInput();
                });

                // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        addAppliance();
                    }
                });
            };

            // ================= æ•°æ®å­˜å‚¨ =================
            const loadFromStorage = () => {
                const savedData = localStorage.getItem('energyAnalyzer');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        state.appliances = parsed.appliances || [];
                        state.settings = { ...state.settings, ...(parsed.settings || {}) };
                    } catch (e) {
                        console.error('å­˜å‚¨æ•°æ®è§£æå¤±è´¥', e);
                    }
                }
            };

            const saveToStorage = () => {
                const data = {
                    appliances: state.appliances,
                    settings: state.settings,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('energyAnalyzer', JSON.stringify(data));
            };

            // ================= è®¾å¤‡ç®¡ç† =================
            const addAppliance = () => {
                if (!validatePowerInput()) return;

                const appliance = {
                    id: 'app_' + Date.now(),
                    name: state.domRefs.applianceName.value || 'æœªå‘½åè®¾å¤‡',
                    power: parseFloat(state.domRefs.appliancePower.value),
                    hours: parseFloat(state.domRefs.applianceHours.value),
                    category: state.domRefs.applianceCategory.value
                };

                state.appliances.push(appliance);
                updateUI();
                saveToStorage();

                // æ¸…ç©ºè¡¨å•
                state.domRefs.applianceName.value = '';
                state.domRefs.appliancePower.value = '100';
            };

            const removeAppliance = (id) => {
                state.appliances = state.appliances.filter(app => app.id !== id);
                updateUI();
                saveToStorage();
            };

            // ================= è¾“å…¥éªŒè¯ =================
            const validatePowerInput = () => {
                const powerInput = state.domRefs.appliancePower;
                const errorMsg = powerInput.nextElementSibling;
                const powerValue = parseFloat(powerInput.value);

                if (isNaN(powerValue) || powerValue < 10) {
                    powerInput.parentElement.classList.add('invalid');
                    errorMsg.style.display = 'block';
                    return false;
                }

                powerInput.parentElement.classList.remove('invalid');
                errorMsg.style.display = 'none';
                return true;
            };

            // ================= è®¡ç®—å‡½æ•° =================
            const calculateDailyConsumption = () => {
                return state.appliances.reduce((sum, app) =>
                    sum + (app.power * app.hours / 1000), 0);
            };

            const calculateMonthlyCost = () => {
                const daily = calculateDailyConsumption();
                return daily * 30 * state.settings.electricityRate;
            };

            const calculateCarbonFootprint = () => {
                const daily = calculateDailyConsumption();
                return daily * 30 * state.settings.carbonFactor;
            };

            // ================= UIæ›´æ–° =================
            const updateUI = () => {
                updateStats();
                renderApplianceList();
                updateChart();
            };

            const updateStats = () => {
                const dailyConsumption = calculateDailyConsumption().toFixed(1);
                const monthlyCost = calculateMonthlyCost().toFixed(0);
                const carbonFootprint = calculateCarbonFootprint().toFixed(1);

                state.domRefs.dailyConsumption.textContent = `${dailyConsumption} kWh`;
                state.domRefs.monthlyCost.textContent = `Â¥ ${monthlyCost}`;
                state.domRefs.carbonFootprint.textContent = `${carbonFootprint} kg`;

                // æ›´æ–°è¿›åº¦æ¡
                updateProgressBars(dailyConsumption);
            };

            const updateProgressBars = (dailyConsumption) => {
                const progressBars = document.querySelectorAll('.progress-fill');
                const maxDaily = 30; // å‡è®¾æœ€å¤§æ¯æ—¥æ¶ˆè€—30kWh
                const percentage = Math.min((dailyConsumption / maxDaily) * 100, 100);

                progressBars.forEach(bar => {
                    bar.style.width = `${percentage}%`;
                });
            };

            const renderApplianceList = () => {
                const listEl = state.domRefs.applianceList;

                if (state.appliances.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <p>å°šæœªæ·»åŠ ä»»ä½•è®¾å¤‡</p>
                            <button class="btn" onclick="EnergyAnalyzer.addSampleData()">
                                åŠ è½½ç¤ºä¾‹æ•°æ®
                            </button>
                        </div>`;
                    return;
                }

                listEl.innerHTML = '';

                state.appliances.forEach(appliance => {
                    const dailyConsumption = (appliance.power * appliance.hours / 1000).toFixed(2);

                    const item = document.createElement('div');
                    item.className = 'appliance-item';
                    item.innerHTML = `
                        <div class="appliance-info">
                            <div class="appliance-header">
                                <span class="appliance-icon">${getCategoryIcon(appliance.category)}</span>
                                <strong>${appliance.name}</strong>
                            </div>
                            <div class="appliance-details">
                                <div>åŠŸç‡: ${appliance.power}W</div>
                                <div>æ¯æ—¥ä½¿ç”¨: ${appliance.hours}å°æ—¶</div>
                                <div>æ—¥è€—ç”µ: ${dailyConsumption}åº¦</div>
                            </div>
                        </div>
                        <button class="delete-btn" 
                                aria-label="åˆ é™¤è®¾å¤‡"
                                onclick="EnergyAnalyzer.removeAppliance('${appliance.id}')">
                            &times;
                        </button>
                    `;

                    listEl.appendChild(item);
                });
            };

            const getCategoryIcon = (category) => {
                const icons = {
                    'å†·æš–ç©ºèª¿': 'â„ï¸',
                    'ç…§æ˜è¨­å‚™': 'ğŸ’¡',
                    'å®¶åº­å¨›æ¨‚': 'ğŸ“º',
                    'å»šæˆ¿é›»å™¨': 'ğŸ³',
                    'æ´—è¡£æ¸…æ½”': 'ğŸ§º',
                    'è¾¦å…¬è¨­å‚™': 'ğŸ’»',
                    'å…¶ä»–': 'ğŸ”Œ'
                };
                return icons[category] || 'âš¡';
            };

            // ================= å›¾è¡¨æ§åˆ¶ =================
            const initChart = () => {
                const ctx = document.getElementById('energy-chart').getContext('2d');
                state.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: getChartData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const updateChart = () => {
                if (!state.chart) {
                    initChart();
                    return;
                }

                state.chart.data = getChartData();
                state.chart.update();
            };

            const getChartData = () => {
                // æŒ‰ç±»åˆ«åˆ†ç»„è®¡ç®—èƒ½è€—
                const categories = {};
                state.appliances.forEach(appliance => {
                    const consumption = appliance.power * appliance.hours / 1000;
                    if (!categories[appliance.category]) {
                        categories[appliance.category] = 0;
                    }
                    categories[appliance.category] += consumption;
                });

                // è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®æ ¼å¼
                const labels = Object.keys(categories);
                const data = Object.values(categories);
                const backgroundColors = [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)'
                ];

                return {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                };
            };

            // ================= å…³é”®ä¿®å¤ï¼šæ ‡è®°åŠ è½½å®Œæˆ =================
            const markAsLoaded = () => {
                document.body.classList.add('loaded');
                document.querySelector('.container').style.opacity = 1;
                document.getElementById('loader').style.opacity = 0;

                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                }, 500);
            };

            // ================= å…¬å…±API =================
            return {
                init,
                addAppliance,
                removeAppliance,
                addSampleData: () => {
                    state.appliances = [
                        { id: 'ac1', name: 'å˜é¢‘ç©ºè°ƒ', power: 1500, hours: 6, category: 'å†·æš–ç©ºèª¿' },
                        { id: 'led1', name: 'LEDå¸é¡¶ç¯', power: 40, hours: 5, category: 'ç…§æ˜è¨­å‚™' },
                        { id: 'tv1', name: '4Kç”µè§†', power: 120, hours: 3, category: 'å®¶åº­å¨›æ¨‚' }
                    ];
                    updateUI();
                    saveToStorage();
                }
            };
        })();

        // ======================= åˆå§‹åŒ–åº”ç”¨ =======================
        window.addEventListener('DOMContentLoaded', () => {
            EnergyAnalyzer.init();

            // æ·»åŠ 5ç§’è¶…æ—¶ä¿æŠ¤
            setTimeout(() => {
                if (!document.body.classList.contains('loaded')) {
                    document.querySelector('.container').innerHTML = `
                        <div style="text-align:center; padding:50px">
                            <h2>åˆå§‹åŒ–è¶…æ—¶</h2>
                            <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢</p>
                            <button onclick="location.reload()" style="padding:10px 20px; margin-top:20px">
                                é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
            }, 5000);
        });

        // å…¨å±€è®¿é—®
        window.EnergyAnalyzer = EnergyAnalyzer;
    </script>
</body>

</html>